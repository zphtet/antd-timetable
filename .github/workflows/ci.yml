name: React Vite CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install --force

      # 4Ô∏è‚É£ Run tests
      - name: Run tests
        run: npm run test

      # 5Ô∏è‚É£ Build app
      - name: Build app
        run: npm run build

      # 6Ô∏è‚É£ Set up Docker Buildx (for multi-arch)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 7Ô∏è‚É£ Authenticate to GCP using service account
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 8Ô∏è‚É£ Configure Docker for Artifact Registry
      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      # 9Ô∏è‚É£ Build & push Docker image for amd64
      - name: Build and Push Docker Image
        run: |
          IMAGE=us-central1-docker.pkg.dev/new-react-project-483118/docker-repo/vite-ant:latest
          docker buildx build --platform linux/amd64 -t $IMAGE --push .

      # üîü Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy vite-ant \
            --image us-central1-docker.pkg.dev/new-react-project-483118/docker-repo/vite-ant:latest \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated